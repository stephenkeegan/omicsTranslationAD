---
title: "Functional Alignment using AD Biological Domains"
output: html_document
teaching: 45
exercises: 15
questions:
- "How to compare functional signatures from omics data between species?"
objectives:
- "Understand how to detect changes in groups of related genes within a dataset."
- "Identify the common pitfalls of performing functional analyses."
- "Understand the source and utility of the biological domains of Alzheimer's disease."
- "Use biological domain annotations to summarise and compare functional enrichments."
keypoints:
- "Functional signatures are a useful point of comparison between species."
- "Subsetting functions into associated Biological Domains allows for more granular comparisons."
---

Author: Greg Cary, The Jackson Laboratory

```{r setup, include=FALSE}
source("../bin/chunk-options.R")
knitr_fig_path("05-")
```

## Load libraries
```{r libs, warning=FALSE}
suppressPackageStartupMessages(library("tidyverse"))
suppressPackageStartupMessages(library("org.Mm.eg.db"))
suppressPackageStartupMessages(library("org.Hs.eg.db"))
suppressPackageStartupMessages(library("clusterProfiler"))
suppressPackageStartupMessages(library("cowplot"))
suppressPackageStartupMessages(library("synapser"))
suppressPackageStartupMessages(library("ggridges"))
```

<!-- ## Download data (some/all of this may have already been done and/or computed in previous steps) -->

<!-- ```{r} -->
<!-- synLogin() -->

<!-- # biodomain definitions -->
<!-- biodom <- readRDS(synGet('syn25428992')$path) -->
<!-- dom.lab <- read_csv(synGet('syn26856828')$path) -->

<!-- # read mouse results files in synapse directory -->
<!-- syn.dir <- tibble( t = synGetChildren('syn24243915', includeTypes = list('file')) %>% -->
<!--                      synapser::as.list() ) %>% -->
<!--     bind_rows(., -->
<!--               tibble(t = synGetChildren('syn25566108', includeTypes = list('file')) %>% -->
<!--                        synapser::as.list())) %>% -->
<!--     unnest_wider(t) %>% -->
<!--     filter(grepl('JAX', name)) -->

<!-- # download the 5xFAD and LOAD1 mouse data -->
<!-- mm.logfc <- map_dfr( -->
<!--   1:nrow(syn.dir), -->
<!--   ~ synGet(syn.dir$id[.x])$path %>% read_csv(col_types = cols()) -->
<!-- ) -->

<!-- # download human DEG results and module IDs -->
<!-- hs.logfc <- synGet('syn11180450')$path %>% read_tsv(col_types = cols()) -->
<!-- hs.mods <- synTableQuery('select * from syn11932957')$filepath %>% read_csv(col_types = cols()) -->

<!-- ``` -->



## Detecting functional coherence of gene sets from omics data

Most omics analysis approaches produce data on many thousands of genomic features (i.e. transcripts, proteins, etc.) for each condition tested. Simply looking at these lists of genes and associated statistics can be daunting and uninformative. We need approaches to identify which biological functions are being impacted by a given experiment from these systems-level measurements.  

Gene functional enrichment analysis describes a variety of statistical methods that identify groups of genes that share a particular biological function or process and show differential association with experimental conditions. Most approaches compare some statistically valid set of differentially expressed features to sets of functional annotations for those features. There are many different functional annotation sets available, some of the more commonly used include:  

 * gene function resources, such as the [Gene Ontology](amigo.geneontology.org/amigo) (i.e. GO)    
 * pathway databases, such as [Reactome](reactiome.org) or [KEGG](www.genome.jp/kegg/)   
 * disease and phenotype ontologies, such as the [Human Phenotype Ontology](hpo.jax.org/app), the [Mammalian Phenotype Ontology](www.informatics.jax.org/vocab/mp_ontology), and the [Disease Ontology](https://disease-ontology.org/)   

These are the resources that are the foundation for many genomics knowledge bases, such as [MGI](www.informatics.jax.org), [monarch initiative](monarchinitiative.org), and  the [Alliance of Genome Resources](alliancegenome.org). The the precise nature of each of these resources varies, but the core information contained within each is the relationship of sets of genes to biologically meaningful annotations. These annotations are typically expertly curated from the published literature.

There are a variety of statistical approaches that can be employed to test for functional enrichment among genes identified from an omics dataset. Two of the most common broad classes of tests are *over-representation analysis (ORA)* and *gene set enrichment analysis (GSEA)*. For example, consider the figure below from [Zhao & Rhee, Trends in Genetics (2023)](https://doi.org/10.1016/j.tig.2023.01.003). Let's consider each in a bit more detail.  

![Functional enrichment approaches](../fig/Zhao_Rhee_TrendsGenetics_pathway_enrichment.jpg)

### Over-representation analysis

*ORA* involves statistical tests of overlap between two lists of genes: one derived from the experiment and one from the functional annotations. For example, one might ask what is the overlap between the genes in an annotation class, such as "Lysosome", and the genes that are significantly up-regulated in a given experimental condition. These tests usually rely on some form of Fisher's exact test (e.g. `fisher.test()`) or hypergeometric test (e.g. `phyper()`). If the gene lists consist of a larger number of overlapping genes than would be expected at random - given the sample sizes involved - then there is said to be a statistical over-representation of the annotation class within the experimental condition.  

Of course, these overlap tests are generally considered for all annotation classes, which can number in the hundreds to thousands. Performing this many statistical tests ensures that many will be identified as significant by chance. Therefore, there is typically a requirement to correct for multiple testing errors (e.g. `p.adjust()`). 

There are many R packages available to handle the statistical tests and corrections involved in ORA. Today we'll use `clusterProfiler::enrichGO()`, which wraps statistical testing for overlap with GO terms and multiple test correction in one function. 
Let's start by considering the enrichments from the mouse data analyzed previously. 

```{r}
theme_set(theme_bw())
load('../results/DEAnalysis_5XFAD.RData')
#load('../data/DEAnalysis_5XFAD.RData')
```

We'll start by considering the genes that are significantly DE in 12 month old male animals
```{r}
gene.list.up <- DE_5xFAD.df %>% 
  filter(sex == 'male', 
         age == '12 mo',
         padj <= 0.05, 
         log2FoldChange > 0) %>%
  arrange(desc(log2FoldChange)) %>% 
  filter(!duplicated(symbol), !is.na(symbol)) %>% 
  pull(symbol) %>% 
  unique()

gene.list.dn <- DE_5xFAD.df %>% 
  filter(sex == 'male', 
         age == '12 mo',
         padj <= 0.05, 
         log2FoldChange < 0) %>%
  arrange(desc(log2FoldChange)) %>% 
  filter(!duplicated(symbol), !is.na(symbol)) %>% 
  pull(symbol) %>% 
  unique()

length(gene.list.up)
length(gene.list.dn)
```


There are a total of 1,055 significantly up-regulated genes and 491 significantly down-regulated genes in this cohort. Now test for over representation of GO terms among the DEGs. First, we need to identify the universe of all possible genes which includes the genes that were both measured by the experiment and contained within the annotation set.

```{r}
univ <- as.data.frame(org.Mm.egGO) %>% 
  pull(gene_id) %>% 
  unique() %>% 
  bitr(., fromType = "ENTREZID", toType = 'SYMBOL', OrgDb = org.Mm.eg.db, drop = T) %>% 
  pull('SYMBOL') %>% 
  intersect(., DE_5xFAD.df$symbol)
```

Now let's test for enriched GO terms (this can take 3-4 minutes)

```{r}
enr.up <- enrichGO(gene.list.up, 
                   ont = 'all', 
                   OrgDb = org.Mm.eg.db, 
                   keyType = 'SYMBOL',
                   universe = univ
                   )
enr.dn <- enrichGO(gene.list.dn, 
                   ont = 'all', 
                   OrgDb = org.Mm.eg.db, 
                   keyType = 'SYMBOL',
                   universe = univ
                   )
```

How many significant terms are identified:  

```{r}
enr.up@result %>% filter(p.adjust <= 0.05) %>% pull(ID) %>% unique() %>% length()
enr.dn@result %>% filter(p.adjust <= 0.05) %>% pull(ID) %>% unique() %>% length()
```

> ## Challenge 1
> 1) How many significant terms are identified from the up-regulated gene list if you do not specify the "universe"?   
>
> > ## Solution to Challenge 1
> >
> > ~~~
> > enrichGO(gene.list.up, ont = 'all', OrgDb = org.Mm.eg.db, keyType = 'SYMBOL') %>% .@result %>% filter(p.adjust <= 0.05) %>% pull(ID) %>% unique() %>% length()  
> > ~~~
> > {: .language-r}
> {: .solution}
{: .challenge}

Plot the top 10 significant terms:  

```{r significant_terms, fig.width=10, fig.show='hide'}
cowplot::plot_grid(
  dotplot(enr.dn, showCategory = 10) + ggtitle('down'),
  dotplot(enr.up, showCategory = 10) + ggtitle('up')
)
```

```{r, echo=FALSE, warning=FALSE, include=FALSE}
png(file="../results/significantTerms.png", width=12, height=6, units="in", res = 1200)
cowplot::plot_grid(
  dotplot(enr.dn, showCategory = 10) + ggtitle('down'),
  dotplot(enr.up, showCategory = 10) + ggtitle('up'))
dev.off()
```

![significantTerms](../results/significantTerms.png) 

From this we can see that nervous system related terms (e.g. "learning or memory", "neurotransmitter transport") are down in 5xFAD males at 12 months, while immune functions (e.g. "cytokine-mediated signaling pathway" and "leukocyte mediated immunity") are up in 5xFAD males at 12 months.  

### Gene set enrichment analysis

`GSEA` is an alternative approach that uses a statistical measure from the omics data (e.g. the log fold change or significance) to rank the genes. An "enrichment score" is calculated for each annotation set based on where the genes annotated to the term sit in the overall distribution. 

Let's analyze those same data with the `clusterProfiler::gseGO()` function. First we'll specify the gene list and use the `log2FoldChange` value to rank the genes in the list.  

```{r}
gene.list <- DE_5xFAD.df %>% 
  filter(sex == 'male', 
         age == '12 mo',
         padj <= 0.05
         ) %>%
  arrange(desc(log2FoldChange)) %>% 
  filter(!duplicated(symbol), !is.na(symbol)) %>% 
  pull(log2FoldChange, name = symbol)
```

Now we'll test for enrichment:  

```{r warning=FALSE, message=FALSE}
enr <- gseGO(gene.list, ont = 'all', OrgDb = org.Mm.eg.db, keyType = 'SYMBOL')
```

How many significant terms are identified:  

```{r}
enr@result %>% filter(p.adjust <= 0.05) %>% pull(ID) %>% unique() %>% length()
```

> ## Challenge 2
> 1) The tally above represents all genes, both up- and down-regulatd. To compare between GSEA and ORA, can you identify how many GSEA enriched terms are associated with up-regulated genes and how many are associated with down-regulated genes? (Hint: the `NES` value within the results relates to the directionality of enrichment). 
>
> > ## Solution to Challenge 2
> >
> > ~~~
> > enr@result %>% filter(p.adjust <= 0.05, NES < 0) %>% pull(ID) %>% unique() %>% length()  
> > enr@result %>% filter(p.adjust <= 0.05, NES > 0) %>% pull(ID) %>% unique() %>% length()
> > ~~~
> > {: .language-r}
> {: .solution}
{: .challenge}

Plot the term enrichments

```{r term_enrichments, fig.show='hide'}
ridgeplot(enr, core_enrichment = T, showCategory = 20)
```

```{r, echo=FALSE, warning=FALSE, include=FALSE}
png(file="../results/ridgePlot.png", width=12, height=10, units="in", res = 1200)
ridgeplot(enr, core_enrichment = T, showCategory = 20)
dev.off()
```

![ridgeplot](../results/ridgePlot.png)

This plot shows the top 20 GSEA enriched terms. The displayed terms are all from the up-regulated class (i.e. `NES` > 0), and consist of many immune-relevant terms (e.g. "immune response" and "cytokine production"). 

### Common pitfalls & best practices

These kinds of functional enrichment analyses are very common, but not all results reported are equal! A recent paper describes an ["Urgent need for consistent standards in functional enrichment analysis"](https://journals.plos.org/ploscompbiol/article?id=10.1371/journal.pcbi.1009935). They examine how the results of functional enrichment analyses are reported in the literature, and identify several common shortcomings. Watch out for these common mistakes when performing and reporting your own analyses!  

![Common pitfalls](../fig/Wijesooriya_PLOS_CompBio_F2_cropped.png)

## Alzheimers's Disease Biological Domains

While these results are informative and help to provide essential biological context to the results of the omics experiment, it is difficult to understand all of the enriched terms and what that means for the biology of disease. It would be useful to group each of the enriched terms within broader areas of disease biology. There are several common molecular endophenotypes that are detected within human Alzheimer's cohorts across omics data types (transcriptomics, proteomics, and genetics). Several of these endophenotypic areas are shown in the figure below (source: Jesse Wiley).  

![Endophenotypes of AD](../fig/AD_endophenotypes.png)

These endophenotypes describe molecular processes that are dysregulated by or during the disease process. Very similar sets of endophenotypes have been cataloged among the targets of therapeutics in clinical trials for AD (see below, [Cummings et al, Alzheimer's disease drug development pipeline: 2023, Alz Dem TRCI](https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10210334/).  

![Common AD Research Ontology](../fig/CADRO_2023.jpg)

![Drugs in Pipeline by CADRO](../fig/CADRO_2023_2.jpg)

In order to formalize and operationalize these endophenotypic areas, the [Emory-Sage-SGC center of the TREAT-AD consortium](treatad.org/emory-sage-sgc/) has developed the [biological domains](https://alz-journals.onlinelibrary.wiley.com/doi/pdfdirect/10.1002/trc2.12461) of AD. In the enumeration of these domains, several criteria were established; the biological domains defined should be:  

 * *objective:* leverage existing well-annotated resources  
 * *automatable:* in CADRO, therapeutics and targets are manually assigned  
 * *intelligible:* groupings should be easy to understand  
 * *modifiable:* definitions should be (and are!) continuously be updated. 

In all 19 distinct biological domains (aka biodoms) have been identified. These biological domains are defined using sets of GO terms that align with the endophenotype. For example, terms like "cytokine receptor binding" and "leukocyte migration" are annotated to the `Immune Response` biodomain, while terms like "postsynaptic density" and "synaptic vesicle cycle" are annotated to the `Synapse` biodomain. Of all terms in the GO, 7,127 terms (16.4%) are annotated to one of the biological domains. Because the GO terms have genes annotated, genes can be associate with specific endophenotypes via the biological domain groupings of terms. In all, 18,289 genes annotated to at least 1 biodom term. While the biodomains exhibit very few overlapping GO terms (panel A), due to gene pleiotropy (etc) the number of overlapping genes between biological domains is quite a bit higher (panel B). The development of the biological domains is described in more detail in the medRxiv preprint [Genetic and Multi-omic Risk Assessment of Alzheimer’s Disease Implicates Core Associated Biological Domains](www.medrxiv.org/content/10.1101/2022.12.15.22283478v1.full). 

![AD Biodomain Demographics](../fig/score_domains_preprint_F1_cropped.jpeg)


### Download and explore the biological domain annotations

First let's download the biodomain definition file from synapse.  
```{r}
synLogin()

# biodomain definitions
biodom <- readRDS(synGet('syn25428992')$path)
dom.lab <- read_csv(synGet('syn26856828')$path)
```

What is in the file?
```{r}
head(biodom)
```

You can see the file is a list of GO term accessions (`GO_ID`) and names (`GOterm_Name`) as well as the corresponding endophenotype (`Biodomain`) to which the term is annotated. There are also gene annotations for each term. These annotation sets come from two sources: (1) the `symbol` and `uniprot` annotations are drawn directly from the Gene Ontology via the provided API, (2) `ensembl_id`, `entrez_id`, and `hgnc_symbol` are from BioMart annotations (e.g. `biomaRt::getLDS()`).  

We can see how many GO terms are annotated to each biodomain: 

```{r}
biodom %>% group_by(Biodomain) %>% summarise(n_term = length(unique(GO_ID))) %>% arrange(n_term) 
```

The biodomains range in size from `Tau Homeostasis` (10 terms) up to `Synapse` (1,379 terms).

We can also investigate the individual genes annotated to each biodomain term.

```{r}
biodom %>% filter(GOterm_Name == 'amyloid-beta formation') %>% pull(symbol) %>% unlist()
```

So the genes associated with `amyloid-beta formation` within the `APP Metabolism` biodomain include PSEN1, PSEN2, BACE1, ABCA7, NCSTN, and others.  

### Annotate enriched terms with biological domain 

Let's re-characterize the 5xFAD functional enrichments we computed previously with the biological domain annotations and see if we can get more context about what is changing in that model. We'll focus first on the GSEA results and start by annotating the results with biodomain groupings.  

```{r}
enr.bd = enr@result %>% 
  left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% 
  relocate(Biodomain)

head(enr.bd[,1:4])
```

Not all of the enriched terms are annotated to a biological domain. Some terms are too broad and not specific (e.g. 'defense response'), while others may not have been captured by a biological domain annotation yet (e.g. 'regulation of immune system process'). Remember that the conception of the biodomains involved a requirement that they be modifiable, and these terms may be added to the biodomain in the future. Let's modify the `Biodomain` value for terms that aren't annotated to a domain to 'none'.  

```{r}
enr.bd$Biodomain[is.na(enr.bd$Biodomain)] <- 'none'
head(enr.bd[,1:4])
```

How many terms are enriched from each domain?

```{r}
bd.tally = tibble(domain = c(unique(biodom$Biodomain), 'none')) %>% 
  rowwise() %>% 
  mutate(
    n_term = biodom$GO_ID[ biodom$Biodomain == domain ] %>% unique() %>% length(),
    n_sig_term = enr.bd$ID[ enr.bd$Biodomain == domain ] %>% unique() %>% length()
    )
arrange(bd.tally, desc(n_sig_term))
```

Many enriched terms don't map to a domain (134), but most do (`r bd.tally %>% filter(domain != 'none') %>% pull(n_sig_term) %>% sum()`). Of those that do, the vast majority map into the `Immune Response` biodomain.  

We can plot the enrichment results, stratified by biodomain:  

```{r enrichment_results}
enr.bd <- full_join(enr.bd, dom.lab, by = c('Biodomain' = 'domain')) %>% 
  mutate(Biodomain = factor(Biodomain, levels = arrange(bd.tally, n_sig_term) %>% pull(domain))) %>% 
  arrange(Biodomain, p.adjust) 

ggplot(enr.bd, aes(NES, Biodomain)) +
  geom_violin(data = subset(enr.bd, NES > 0), 
              aes(color = color), scale = 'width')+
  geom_violin(data = subset(enr.bd, NES < 0), 
              aes(color = color), scale = 'width')+
  geom_jitter(aes(size = -log10(p.adjust), fill = color), 
              color = 'grey20', shape = 21, alpha = .3)+
  geom_vline(xintercept = 0, lwd = .5, lty = 2)+
  scale_y_discrete(drop = F)+
  scale_fill_identity()+scale_color_identity()
```

We can produce a similar plot for the ORA results. Let's combine the up and down analyses into one, and make the adjusted p-value signed so that we can look at terms that are up and down separately:  

```{r ORA_results, warning=FALSE, message=FALSE}
enr.ora = bind_rows(
  enr.up@result %>% mutate(dir = 'up'),
  enr.dn@result %>% mutate(dir = 'dn')
  ) %>% 
  left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% 
  relocate(Biodomain)

enr.ora$Biodomain[is.na(enr.ora$Biodomain)] <- 'none'

bd.tally = tibble(domain = c(unique(biodom$Biodomain), 'none')) %>% 
  rowwise() %>% 
  mutate(
    n_term = biodom$GO_ID[ biodom$Biodomain == domain ] %>% unique() %>% length(),
    n_sig_term = enr.ora$ID[ enr.ora$Biodomain == domain ] %>% unique() %>% length()
    )

enr.ora <- full_join(enr.ora, dom.lab, by = c('Biodomain' = 'domain')) %>% 
  mutate(Biodomain = factor(Biodomain, levels = arrange(bd.tally, n_sig_term) %>% pull(domain))) %>% 
  arrange(Biodomain, p.adjust) %>% 
  mutate(signed_logP = -log10(p.adjust),
         signed_logP = if_else(dir == 'dn', -1*signed_logP, signed_logP))
  
ggplot(enr.ora, aes(signed_logP, Biodomain)) +
  geom_violin(data = subset(enr.ora, dir == 'up'), aes(color = color), scale = 'width')+
  geom_violin(data = subset(enr.ora, dir == 'dn'), aes(color = color), scale = 'width')+
  geom_jitter(aes(size = Count, fill = color), color = 'grey20', shape = 21, alpha = .3)+
  geom_vline(xintercept = 0, lwd = .5, lty = 2)+
  scale_y_discrete(drop = F)+
  scale_fill_identity()+scale_color_identity()
```

Because there are many more significantly enriched terms from the ORA, there is more detail to consider. The dominant signal is stil the up-regulation of terms from the `Immune Response` biodomain. There is also nearly exclusive up-regulation of terms from the `Autophagy`, `Metal Binding and Homeostasis`, `Oxidative Stress`, and `APP Metabolism` domains. The most down-regulated terms are from the `Synapse` biodomain.

> ## Challenge 3
> 1) While there are many more terms identified using ORA compared with GSEA, how many Biodomain terms are identified in both analyses vs unique to each?
> 2) Which biodomains and terms are uniquely identified in the GSEA analysis?
>
> > ## Solution to Challenge 3
> >
> > 1). 
> > ~~~
> > intersect(enr.bd$Description[enr.bd$Biodomain!='none'], enr.ora$Description[enr.ora$Biodomain!='none']) %>% length()  
> > ~~~
> > {: .language-r}
> > 133 in common
> > ~~~
> > setdiff(enr.bd$Description[enr.bd$Biodomain!='none'], enr.ora$Description[enr.ora$Biodomain!='none']) %>% length()
> > ~~~
> > {: .language-r}
> > 20 unique to GSEA
> > ~~~
> > setdiff(enr.ora$Description[enr.ora$Biodomain!='none'], enr.bd$Description[enr.bd$Biodomain!='none']) %>% length()
> > ~~~
> > {: .language-r}
> > 908 unique to ORA
> >
> > 2). 
> > ~~~
> > enr.bd %>% filter( Description %in% setdiff(enr.bd$Description[enr.bd$Biodomain!='none'], enr.ora$Description[enr.ora$Biodomain!='none']) ) %>% group_by(Biodomain) %>% summarise(terms = paste0(Description, collapse = ', '))
> > ~~~
> > {: .language-r}
> > Most terms unique to GSEA are from the 'Immune Response' domain (13), but there are also terms from 'Structural Stabilization' (4), 'Apoptosis' (2), and 'Synapse' (1) that are unique to the GSEA results. 
> {: .solution}
{: .challenge}

### Biological domains over model age

Let's take a look at how biodomain enrichments from the MODEL-AD strains change with respect to the age of the model. To save some time, let's load some pre-computed enrichment results for mouse & human data.  

```{r, warning=FALSE, message=FALSE}
mm.ora <- bind_rows(
  read_tsv('../data/5xFAD_ora_results.tsv', col_types = cols()) %>%
    mutate(age = str_remove_all(age, ' mo') %>% as.double()),
  read_tsv('../data/LOAD1_ora_results.tsv', col_types = cols())
)
mm.gsea <- bind_rows(
  read_tsv('../data/5xFAD_gsea_results.tsv', col_types = cols()) %>%
    mutate(age = str_remove_all(age, ' mo') %>% as.double()),
  read_tsv('../data/LOAD1_gsea_results.tsv', col_types = cols())
)

hs.ora <- read_tsv('../data/Hsap_ora_results.tsv', col_types = cols())
hs.gsea <- read_tsv('../data/Hsap_gsea_results.tsv', col_types = cols())
```

Annotate and plot the 5xFAD Male results, this time faceting by biodomain to compare across the age groups:
```{r Male_5xFAD_biodomain, warning=FALSE, message=FALSE}
enr.bd = mm.ora %>% 
  filter(model == '5xFAD', sex == 'male') %>% 
  left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% 
  relocate(Biodomain) %>% 
  mutate(Biodomain = if_else( is.na(Biodomain), 'none', Biodomain),
         signed_logP = -log10(p.adjust),
         signed_logP = if_else(dir == 'ora_dn', -1*signed_logP, signed_logP))

bd.tally = tibble(domain = c(unique(biodom$Biodomain), 'none')) %>% 
  rowwise() %>% 
  mutate(
    n_term = biodom$GO_ID[ biodom$Biodomain == domain ] %>% unique() %>% length(),
    n_sig_term = enr.bd$ID[ enr.bd$Biodomain == domain ] %>% unique() %>% length()
    )

enr.bd <- full_join(enr.bd, dom.lab, by = c('Biodomain' = 'domain')) %>% 
  mutate(age = factor(age, enr.bd$age %>% unique() %>% sort(decreasing = T) ),
         Biodomain = factor(Biodomain, levels = arrange(bd.tally, desc(n_sig_term)) %>% pull(domain))) %>% 
  arrange(Biodomain, p.adjust)

ggplot(enr.bd, aes(signed_logP, age)) +
  geom_violin(data = subset(enr.bd, signed_logP > 0), aes(color = color), scale = 'width')+
  geom_violin(data = subset(enr.bd, signed_logP < 0), aes(color = color), scale = 'width')+
  geom_point(aes(size = Count, fill = color, group = ID), 
              color = 'grey20', shape = 21, alpha = .5, position = position_jitter(width = .25, seed = 2)  )+
  facet_wrap(~Biodomain)+
  geom_vline(xintercept = 0, lwd = .5, lty = 2)+
  scale_fill_identity()+scale_color_identity()
```

The `Immune Response` terms are over-represented among the up-regulated genes at all ages, but the overall significance of the associations increase with age. Similar age-dependent trends are apparent in other domains as well. Of note is the increasing number of terms from the `Synapse` domain over-represented among the down-regulated genes as the animals age. 

Let's consider the APOE4Trem2 results. Annotate the biodomains and plot the results of ORA from the DE genes in APOE4Trem2 Males:
```{r APOE4Trem2_biodomain, warning=FALSE, message=FALSE}
enr.bd = mm.ora %>% 
  filter(model == 'APOE4Trem2', sex == 'male') %>% 
  left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% 
  relocate(Biodomain) %>% 
  mutate(Biodomain = if_else( is.na(Biodomain), 'none', Biodomain),
         signed_logP = -log10(p.adjust),
         signed_logP = if_else(dir == 'ora_dn', -1*signed_logP, signed_logP))

bd.tally = tibble(domain = c(unique(biodom$Biodomain), 'none')) %>% 
  rowwise() %>% 
  mutate(
    n_term = biodom$GO_ID[ biodom$Biodomain == domain ] %>% unique() %>% length(),
    n_sig_term = enr.bd$ID[ enr.bd$Biodomain == domain ] %>% unique() %>% length()
    )

enr.bd <- full_join(enr.bd, dom.lab, by = c('Biodomain' = 'domain')) %>%  
  filter(!is.na(age)) %>% 
  mutate(age = factor(age, levels = enr.bd$age %>% unique() %>% sort(decreasing = T)),
         Biodomain = factor(Biodomain, 
                            levels = arrange(bd.tally, desc(n_sig_term)) %>% pull(domain))) %>% 
  arrange(age, desc(Biodomain),  p.adjust) 

ggplot(enr.bd, aes(signed_logP, age)) +
  geom_violin(data = subset(enr.bd, signed_logP > 0), aes(color = color), scale = 'width')+
  geom_violin(data = subset(enr.bd, signed_logP < 0), aes(color = color), scale = 'width')+
  geom_jitter(aes(size = Count, fill = color), color = 'grey20', shape = 21, alpha = .5)+
  facet_wrap(~Biodomain)+
  geom_vline(xintercept = 0, lwd = .5, lty = 2)+
  scale_fill_identity()+scale_color_identity()
```

There aren't any terms enriched at the 4 month time point. Unlike the 5xFAD mice, APOE4Trem2 mice show a significant *down-regulation* of `Immune Response` terms, particularly at 8 months, as well as down-regulation in terms from `APP Metabolism` domain. There is an enrichment in terms from the `Synapse` domain for down-regulated genes, despite enrichments among down-regulated genes in cell death related domains `Autophagy` and `Apoptosis`.

> ## Challenge 4
> Terms from `Immune Response` are enriched among the genes up in 5xFAD, but down in APOE4Trem2. Are these similar or different terms in each set? Focus on the 12 month old animals from each model.
>
> > ## Solution to Challenge 4
> >
> > First, get the list of terms associated with up- and down-regulated genes in each model:
> >
> > ~~~
> > xf = mm.ora %>% filter(model == '5xFAD', sex == 'male', age == 12, dir == 'ora_up') %>% left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% filter(Biodomain == 'Immune Response') %>% pull(Description)
> > at = mm.ora %>% filter(model == 'APOE4Trem2', sex == 'male', age == 12, dir == 'ora_dn') %>% left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% filter(Biodomain == 'Immune Response') %>% pull(Description)
> > ~~~
> > {: .language-r}
> > Next how many terms are in each list and how many terms overlap?
> > ~~~
> > length(xf)
> > length(at)
> > length(intersect(at,xf))
> > ~~~
> > {: .language-r}
> > Almost all terms (95.5%) enriched in the down-regulated analysis from APOE4Trem2 are also found in the enrichments from the up-regulated genes in 5xFAD.
> {: .solution}
{: .challenge}

### Comparing Human and Mouse functional enrichments

Finally let's consider how we can compare the functional enrichments in the mouse models with functional enrichments from the AMP-AD cohorts. We can first take a look at the functional enrichments from the different human cohorts. 

The cohorts ans tissues available are:
```{r}
hs.ora %>% select(Study, Tissue) %>% distinct()
```

We can focus on one tissue per cohort, let's look at TCX for Mayo, PHG for Mt Sinai, and DLPFC for ROSMAP. 

```{r biodomain_one_tissue_per_cohort, warning=FALSE, message=FALSE}
enr.bd = hs.ora %>% 
  filter(Tissue %in% c('TCX','PHG','DLPFC')) %>% 
  left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% 
  relocate(Biodomain) %>% 
  mutate(Biodomain = if_else( is.na(Biodomain), 'none', Biodomain),
         signed_logP = -log10(p.adjust),
         signed_logP = if_else(dir == 'ora_dn', -1*signed_logP, signed_logP))

bd.tally = tibble(domain = c(unique(biodom$Biodomain), 'none')) %>% 
  rowwise() %>% 
  mutate(
    n_term = biodom$GO_ID[ biodom$Biodomain == domain ] %>% unique() %>% length(),
    n_sig_term = enr.bd$ID[ enr.bd$Biodomain == domain ] %>% unique() %>% length()
    )

enr.bd <- full_join(enr.bd, dom.lab, by = c('Biodomain' = 'domain')) %>% 
  filter(!is.na(Study)) %>% 
  mutate(Biodomain = factor(Biodomain, levels = arrange(bd.tally, desc(n_sig_term)) %>% pull(domain))) %>% 
  arrange(Biodomain, p.adjust)

ggplot(enr.bd, aes(signed_logP, Biodomain)) +
  geom_violin(data = subset(enr.bd, signed_logP > 0), aes(color = color), scale = 'width')+
  geom_violin(data = subset(enr.bd, signed_logP < 0), aes(color = color), scale = 'width')+
  geom_point(aes(size = Count, fill = color, group = ID), 
              color = 'grey20', shape = 21, alpha = .5, position = position_jitter(width = .25, seed = 2)  )+
  facet_wrap(~paste0(Study, ': ', Tissue))+
  geom_vline(xintercept = 0, lwd = .5, lty = 2)+
  scale_fill_identity()+scale_color_identity()
```

Huh, the Mayo and MSSM look largely similar, but the ROSMAP DLPFC doesn't have very many enriched terms. Let's ignore the ROSMAP result for now and compare the terms enriched between Mayo TCX and the 5xFAD males. First we can join up the enriched terms between the sets into one data frame.

```{r}
comb_5x = bind_rows(
  hs.ora %>% 
    filter(Study == 'MAYO', Tissue == 'TCX') %>% 
    mutate(species = 'hs') %>% 
    select(ID, Description, species, dir, p.adjust, Count),
  mm.ora %>% 
    filter(model == '5xFAD', sex == 'male', age == 12) %>% 
    mutate(species = 'mm') %>% 
    select(ID, Description, species, dir, p.adjust, Count)) %>% 
  mutate(signed_logP = -log10(p.adjust),
         signed_logP = if_else(dir == 'ora_dn', -1*signed_logP, signed_logP)) %>% 
  pivot_wider(id_cols = c(ID, Description), 
              names_from = species, 
              values_from = signed_logP
  ) %>% 
  unnest(cols = c(hs,mm)) %>% 
  mutate(across(c(hs,mm), ~ if_else(is.na(.x), 0, .x)))


head(comb_5x)
```

Great! Now let's annotate the biodomains and plot it up:

```{r annotated_biodomains, warning=FALSE, message=FALSE}
enr.bd <- comb_5x %>% 
  left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% 
  relocate(Biodomain) %>% 
  mutate(Biodomain = if_else( is.na(Biodomain), 'none', Biodomain))

bd.tally = tibble(domain = c(unique(biodom$Biodomain), 'none')) %>% 
  rowwise() %>% 
  mutate(
    n_term = biodom$GO_ID[ biodom$Biodomain == domain ] %>% unique() %>% length(),
    n_sig_term = enr.bd$ID[ enr.bd$Biodomain == domain ] %>% unique() %>% length()
    )

enr.bd <- full_join(enr.bd, dom.lab, by = c('Biodomain' = 'domain')) %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = arrange(bd.tally, desc(n_sig_term)) %>% pull(domain))) %>% 
  arrange(Biodomain)

ggplot(enr.bd, aes(hs, mm)) +
  geom_point(aes(fill = color),color = 'grey20', shape = 21, alpha = .5)+
  geom_vline(xintercept = 0, lwd = .5, lty = 2)+
  geom_hline(yintercept = 0, lwd = .5, lty = 2)+
  facet_wrap(~Biodomain, scales = 'free')+
  scale_fill_identity()
```

There are several terms from multiple biodomains that are enriched in similar directions (i.e. from the up-regulated genes in both human AD and 5xFAD). There are fewer that are enriched in opposite directions (i.e. up in human AD and down in 5xFAD), but there are many terms that are unique to either the human or the mouse data set.

What if we compare the APOE4Trem2 males to Mayo TCX?

```{r APOE4Trem2_MayoTCX}
comb_at = bind_rows(
  hs.ora %>% 
    filter(Study == 'MAYO', Tissue == 'TCX') %>% 
    mutate(species = 'hs') %>% 
    select(ID, Description, species, dir, p.adjust, Count),
  mm.ora %>% 
    filter(model == 'APOE4Trem2', sex == 'male', age == 12) %>% 
    mutate(species = 'mm') %>% 
    select(ID, Description, species, dir, p.adjust, Count)) %>% 
  mutate(signed_logP = -log10(p.adjust),
         signed_logP = if_else(dir == 'ora_dn', -1*signed_logP, signed_logP)) %>% 
  pivot_wider(id_cols = c(ID, Description), 
              names_from = species, 
              values_from = signed_logP
  ) %>% 
  unnest(cols = c(hs,mm)) %>% 
  mutate(across(c(hs,mm), ~ if_else(is.na(.x), 0, .x)))

enr.bd <- comb_at %>% 
  left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% 
  relocate(Biodomain) %>% 
  mutate(Biodomain = if_else( is.na(Biodomain), 'none', Biodomain))

bd.tally = tibble(domain = c(unique(biodom$Biodomain), 'none')) %>% 
  rowwise() %>% 
  mutate(
    n_term = biodom$GO_ID[ biodom$Biodomain == domain ] %>% unique() %>% length(),
    n_sig_term = enr.bd$ID[ enr.bd$Biodomain == domain ] %>% unique() %>% length()
    )

enr.bd <- full_join(enr.bd, dom.lab, by = c('Biodomain' = 'domain')) %>% 
  mutate(Biodomain = factor(Biodomain, 
                            levels = arrange(bd.tally, desc(n_sig_term)) %>% pull(domain))) %>% 
  arrange(Biodomain)

ggplot(enr.bd, aes(hs, mm)) +
  geom_point(aes(fill = color),color = 'grey20', shape = 21, alpha = .5)+
  geom_vline(xintercept = 0, lwd = .5, lty = 2)+
  geom_hline(yintercept = 0, lwd = .5, lty = 2)+
  facet_wrap(~Biodomain, scales = 'free')+
  scale_fill_identity()
```

Many of the terms that are enriched among the down-regulated genes from APOE4Trem2 are enriched from genes up-regulated in AD, especially from `Immune Response` and `Lipid Metabolism` domains.

Overall, by aligning human and mouse omics signatures through the lens of domains affected in each context, we can get a better understanding of the relationships between the biological processes affected in each context. 

> ## Challenge 5
> We haven't focused on it much, but there are terms that aren't in a biodomain and are enriched in opposite direction between the human and mouse model tests. Are there any terms that *aren't* annotated to a biodomain, but are up in humand and down in both animal model tests?
>
> > ## Solution to Challenge 5
> >
> > First, get the list of terms associated with up- and down-regulated genes in each model:
> > ~~~
> > intersect( comb_5x %>% left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>%  filter(is.na(Biodomain), hs > 0, mm < 0) %>% pull(Description), comb_at %>% left_join(., biodom %>% select(Biodomain, ID = GO_ID), by = 'ID') %>% filter(is.na(Biodomain), hs > 0, mm < 0) %>% pull(Description) )
> > ~~~
> > {: .language-r}
> > Intriguingly there are some apparently relevant terms, such as "negative regulation of gliogenesis", that are up in human cohort and down in both mouse models. The biological domain annotations are a helpful tool, but certainly not the whole picture. 
> {: .solution}
{: .challenge}

## Session Info
```{r session_info,collapse=TRUE}
sessionInfo()
```